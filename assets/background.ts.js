import{B as a,H as p,V as o,q as I}from"./Helpers.js";a.runtime.onMessage.addListener((r,e,i)=>{let t=[],n=null;return typeof r.data<"u"&&(t=r.data),n=p.messageExecute(null,r.fn,t),p.messageSendResponse(n,t,e,i)});if(typeof ScrappingInit>"u"){let r=function(e){if(typeof e.wait_time<"u"&&(E=e.wait_time),typeof e.restart_time<"u"&&(h=e.restart_time),typeof e.app_status<"u"&&(M=e.app_status),typeof e.collections<"u"){_=e.collections;let t=0;return o.debugMode&&console.log(_),_.forEach((n,s)=>{if(t==0&&typeof n<"u")return t=1,n=i(n,e),ScrapCall(n),_.splice(s,1),e.collections=_,e}),e}else{let t=i(e,e);ScrapCall(t)}function i(t,n){if(!(typeof t.type>"u"&&typeof n.collection>"u")){if(typeof t.market_place_id>"u"&&typeof t.marketplace_id<"u"&&(t.market_place_id=t.marketplace_id),typeof n.collection<"u"&&typeof t.market_place_id>"u"&&typeof n.collection.market_place_id<"u"&&(t.market_place_id=n.collection.market_place_id),typeof t.url>"u"?(t.origin=o.marketplace_idBydomain[t.market_place_id],t.url=t.origin+t.uri):t.url||(t.origin=o.marketplace_idBydomain[t.market_place_id],t.url=t.origin+t.uri),typeof t.market_place_id<"u"&&(t.base_url=o.marketplace_idBydomain[t.market_place_id]),typeof n.app_status>"u"&&(n.app_status=M),n.app_status!=1){setTimeout(()=>{this.ScarpingEnd()},h*2);return}return t}}return item};var C=0,E=4e3,h=4e4,M=1,A=1,T=Date.now(),_=[];globalThis.ScrapCollection=()=>{let e=((Math.random()+1)*E).toFixed(0);a.storage.sync.get("start_scrap").then(function(i){if(typeof i.start_scrap>"u"&&(i.start_scrap=0),C=i.start_scrap,C===1){o.debugMode&&console.log("Running",e);return}o.debugMode&&console.log("Starting",e,"scrapCout: "+A,new Date().toISOString().replaceAll(/-/g,"_")),C=1,a.storage.local.set({start_scrap:1}).then(()=>{if(Object.keys(_).length>0)return r({collections:_});p.fetchWithTimeout(o.api_url+"/extensions/scraping/get?"+new Date().toISOString().replaceAll(/-/g,"_"),{method:"POST",headers:{"Content-type":"application/json"},body:JSON.stringify({merchants:Object.keys(o.merchants??{})})},3e4).then(t=>t.text()??t).then(t=>{let n=JSON.parse(t);if(n.status=="success")return n=n.data,r(n);setTimeout(()=>{ScarpingEnd()},h*2)}).catch(t=>{o.debugMode&&console.log(t)})})})},globalThis.ScrapCall=(e,i=null)=>{i||(i=o.api_url),T=Date.now();let t=new Headers;return t.append("Access-Control-Allow-Origin",e.origin),fetch(e.url,{mode:"same-origin",headers:t,redirect:"manual"}).then(function(n){return e.header={},n.headers.forEach((s,d)=>{e.header[d]=s}),e.header.status_text=n.statusText,e.header.status_code=n.status,o.debugMode&&console.log(e),n.redirected||n.status!==200?!1:n.text()}).then(n=>{if(o.debugMode&&console.log(n.toString().length,n.toString().indexOf("Type the characters you see")),n&&n.toString().indexOf("Type the characters you see")!==-1)return globalThis.ScarpingEnd(),setTimeout(ScrapCollection,h*2),n;let s=null;if(e.type=="application/json"){let d=new AbortController;setTimeout(u=>{d.abort(),a.runtime.sendMessage(a.runtime.id,{fn:"ScarpingEnd",data:null},l=>l)},5e4),e.data=n,e.header=n,fetch(i+"/extensions/scraping/set?time="+new Date().toISOString().replaceAll(/-/g,"_"),{method:"POST",body:JSON.stringify(e),signal:d.signal})}else a.tabs.query({status:"complete"}).then(d=>{if(d){if(d.forEach(u=>{!s&&u.url.indexOf("https://")!==-1&&u.url.indexOf("webstore")===-1&&(s=u)}),typeof s.id>"u"){setTimeout(()=>{globalThis.ScrapCall(e)},h*2);return}a.scripting.executeScript({target:{tabId:s.id},function:Scraping,args:[n,e.type,e.elements,e,o.api_url,e.header,0,a]}).then(u=>u).catch(u=>{o.debugMode&&console.log(u,"Catch:161")})}else return ScrapCall(e)}).catch(d=>{o.debugMode&&console.log(d,"Catch:168")})}).catch(n=>{o.debugMode&&console.log(n,"Catch:174")})},globalThis.Scraping=(e,i,t,n={},s=null,d=[],u=0,l=null)=>{l==null&&typeof a<"u"&&(l=a??null),typeof l.runtime>"u"&&typeof chrome<"u"&&(l=chrome),s==null&&(s=o.api_url??null);let m=new DOMParser().parseFromString(e,i),y="";if(t){t.forEach(function(c){m.querySelectorAll(c).forEach(function(f){y+=f.outerHTML})}),n.data=y,n.header=d;let S=new AbortController,g=setTimeout(c=>{S.abort(),l.runtime.sendMessage(l.runtime.id,{fn:"ScarpingEnd",data:null},f=>f)},5e4);return fetch(s+"/extensions/scraping/set?time="+new Date().toISOString().replaceAll(/-/g,"_"),{method:"POST",body:JSON.stringify(n),signal:S.signal}).then(c=>c.text()).then(c=>{if(c=JSON.parse(c),new Date().toISOString().replaceAll(/-/g,"_"),typeof c.data<"u"&&typeof c.data.collection_type<"u"&&c.status==="success"){let f=c.data.wait_time??8e3,k=((Math.random()+1)*(f/2)).toFixed(0);return clearTimeout(g),g=null,setTimeout(()=>{l.runtime.sendMessage(l.runtime.id,{fn:"ScrapCall",data:c.data,api_url:s},O=>O)},k),c}l.runtime.sendMessage(l.runtime.id,{fn:"ScarpingEnd",data:null},f=>f),g&&clearTimeout(g)}).catch(c=>{if(S.abort(),g&&clearTimeout(g),u<2)return u++,console.log(c,"Catch"),setTimeout(f=>{globalThis.Scraping(e,i,t,n,o.api_url,d,u,l),clearTimeout(f)},5e4),!1;typeof l.runtime.sendMessage<"u"?setTimeout(()=>{l.runtime.sendMessage(l.runtime.id,{fn:"ScarpingEnd",data:null},f=>f)},6e4):setTimeout(()=>{l.runtime.sendMessage(l.runtime.id,{fn:"ScarpingEnd",data:null},f=>f)},6e4)}),!1}},globalThis.ScarpingEnd=()=>{o.debugMode&&console.log("Finish",h),A++,setTimeout(()=>{a.storage.local.set({start_scrap:0}).then(()=>{ScrapCollection()})},h)},globalThis.ScrapingCheck=()=>{if(M==0)return;let e=((Date.now()-T)/600).toFixed(0),i=(h*10/1e3).toFixed(0);o.debugMode&&console.log("ScrapingChack",e,i,Date.now(),T),e>i&&(ScarpingEnd(),ScrapCollection())},globalThis.ScrappingInit=()=>{p.setKey().then(),ScrapCollection()},ScrappingInit()}let v=!1,w=["token_usage","credits","licences","uuid_hopekey","uuid_search","expires","credit_usage","credit_detail","credit_detail_visual","start_scrap","language_var_sync","language_variables","languages","ai_models","ai_prompts","selected_ask","selected_question","selected_write","prompt_settings","model_settings","files","faq","packages"],D={ai_single:[p.SHA1("image")]};var P=r=>{r.reason=="install"&&w.push("settings"),a.storage.local.remove(w).then(),Object.keys(D).forEach(e=>{a.storage.local.get(e).then(i=>{if(typeof i[e]<"u"){let t=!1,n=!1;try{i[e]=JSON.parse(i[e]),n=!0}catch{}let s=D[e];Object.keys(i[e]).forEach(d=>{s.indexOf(d)===-1&&(t=!0,delete i[e][d])}),n&&(i[e]=JSON.stringify(i[e])),t&&a.storage.local.set(i).then()}})}),a.storage.sync.remove(["uuid_hopekey","uuid_search","ai_setup"]).then(),a.storage.local.set({show_sidebar:!1}).then(),console.log("clearStorage"),a.tabs.query({url:"https://*.chatgptextension.ai/setup"}).then(e=>{e.forEach(i=>{console.log(i),a.tabs.remove(i.id)})}),!v&&(v=!0,p.uuid(1).then(()=>{r.reason=="install"&&p.openPage({url:I.extension_dir+"src/html/setup.html"})}))};a.runtime.onInstalled.addListener(async r=>P(r));a.runtime.onUpdateAvailable.addListener(r=>(a.runtime.reload(),P(r)));a.runtime.setUninstallURL(I.site+"/uninstall");a.storage.sync.get("uuid_hopekey").then(r=>{r.uuid_hopekey==null&&p.uuid(1).then(()=>p.getModelSettings().then())});a.action.onClicked.addListener(r=>{a.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(e=>console.error(e)),a.sidePanel.setOptions({enabled:!0})});a.runtime.onMessage.addListener(r=>{if(r.fn=="action.onCaptureScreen"){const{data:e}=r.data,{x:i,y:t,width:n,height:s,windowWidth:d}=e;if(!n||!s)return;p.captureCurrentViewport().then(u=>{fetch(u).then(l=>l.blob()).then(l=>{createImageBitmap(l).then(b=>{const m=b.width/d,y=i*m,S=t*m,g=n*m,c=s*m,f=new OffscreenCanvas(g,c);f.getContext("2d").drawImage(b,y,S,g,c,0,0,g,c),f.convertToBlob().then(O=>{const x=new FileReader;x.readAsDataURL(O),x.onloadend=()=>{const F=x.result;a.storage.local.set({ai_image_url:F}).then()}})})})}).catch(u=>console.error(u))}});
//# sourceMappingURL=background.ts.js.map
