import{V as p,B as O,H as D}from"./Helpers.js";class P{market_place_id=null;market_host=null;market_country_code=null;amazon_page=!1;market_detail=null;_conf={};_schema={asin:"",is_sponsored:"",price:0,offers:{},sellers:0,bestsellers:{main:{url:"",rank:0,prefix:""},child:[]},group_bestsellers:{url:"",rank:0,prefix:""}};siteLang=null;hostname=null;data={asins:{},market_place_id:null,market_host:null};data_html={};amazon_data={};bestseller_groups={};regex={float:/[-+]?([0-9]*\.[0-9]+|[0-9]+)/,int:/[0-9]+$/,dimension:/^([\d.]+)\s*x\s*([\d.]+)\s*x\s*([\d.]+)\s*(\w+(?:\s+\w+)*)(?:;\s*([\d.]+)\s*(\w+))?$/,weight:/^([\d.]+)\s*(\w+)$/};constructor(){let e=window.location.host.replace("www.","");if(window.location.host.indexOf("www.amazon.")===-1){this.amazon_page=!1;return}else this.amazon_page=!0;this.market_place_id=p.market_urls[e]??null,this.market_host=window.location.hostname.replace("www.",""),this.data.market_place_id=this.market_place_id,this.data.market_host=this.market_host,typeof p.market_host_by_details<"u"&&this.market_host&&(this.market_country_code=p.market_host_by_details[this.market_host]?.country_code?.toUpperCase(),this.market_detail=p.market_host_by_details[this.market_host]),this.bestseller_groups=JSON.parse(sessionStorage.getItem("bestseller_groups")),this.bestseller_groups||(this.bestseller_groups={},this.getBestsellerGroups()),O.storage.local.get("settings").then(s=>{this._conf=s.settings})}scan(){return new Promise(e=>{this.amazon_page==!1&&e(null),document?.querySelectorAll("[name='ASIN']").forEach(s=>{let i=s.getAttribute("value");i.length>0&&typeof this.data.asins[i]>"u"&&this.build(i)}),Object.keys(this.data.asins).length==0&&document?.querySelectorAll("[name='ASIN']").length==0&&document?.querySelectorAll("[data-asin]").forEach(s=>{let i=s.getAttribute("data-asin");i.length>0&&typeof this.data.asins[i]>"u"&&this.build(i)}),e(this.data.asins)})}async build(e){return await new Promise(s=>{let i=this.market_host+"_"+e+"_product_detail";return this.data.asins[e]={asin:e,is_sponsored:!1,amazon:this.amazon_data[e]},fetch(window.location.origin+"/dp/"+e).then(t=>t.text()).then(t=>{this.data_html[e]=t,this.get(this.data.asins[e],t).then(a=>{sessionStorage.setItem(i,JSON.stringify(a)),s(a)})})})}getAmazon(e){if(typeof this.amazon_data[e]<"u")return new Promise(i=>i);let s={url:"https://sellercentral."+this.market_host+"/rcpublic/searchproduct?countryCode="+this.market_country_code+"&locale=en-US",data:{keywords:e,countryCode:this.market_country_code,searchType:"GENERAL",pageOffset:1},method:"POST"};return fetch(p.api_url+"/tunnel",{headers:{accept:"application/json","content-type":"application/json; charset=UTF-8"},body:JSON.stringify(s),method:"POST"}).then(i=>i.json()).then(i=>{i?.succeed&&i.data.products.forEach(t=>(s={url:"https://sellercentral."+this.market_host+"/rcpublic/getfees?countryCode="+this.market_country_code+"&locale=en-US",data:{countryCode:this.market_country_code,itemInfo:{asin:t.asin,glProductGroupName:t.gl,packageLength:t.length,packageWidth:t.width,packageHeight:t.height,dimensionUnit:t.dimensionUnit,packageWeight:t.weight,weightUnit:t.weightUnit,afnPriceStr:t.price,mfnPriceStr:t.price,mfnShippingPriceStr:"0",currency:this.market_detail.currency,isNewDefined:!1},programIdList:["Core","MFN"]},method:"POST"},fetch(p.api_url+"/tunnel",{headers:{accept:"application/json","content-type":"application/json; charset=UTF-8"},body:JSON.stringify(s),method:"POST"}).then(a=>a.json()).then(a=>{if(a?.succeed){t.raw_fees=a?.data?.programFeeResultMap?.Core?.otherFeeInfoMap;let n=t.raw_fees.ReferralFee.total.amount+t.raw_fees.FulfillmentFee.total.amount+t.raw_fees.VariableClosingFee.total.amount+t.raw_fees.FixedClosingFee.total.amount;t.fees={referral_fees:t.raw_fees.ReferralFee.total.amount,fba_fees:t.raw_fees.FulfillmentFee.total.amount,variable_closing_fee:t.raw_fees.VariableClosingFee.total.amount,fixed_closing_fee:t.raw_fees.FixedClosingFee.total.amount,total_fba_fees:n},this.amazon_data[t.asin]=t,this.data[t.asin]=t}}).finally(()=>{this.amazon_data[t.asin]=t})))})}get(e,s){return new Promise(i=>typeof s>"u"?e:(typeof s.querySelectorAll>"u"&&(s=new DOMParser().parseFromString(s,"text/html")),this.data.asins[e.asin].is_apparel=s.querySelector(".apparel")!=null,this.data.asins[e.asin].bestsellers=this.getBestsellers(e,s),this.data.asins[e.asin].group_bestsellers=e.bestsellers?.main??{},this.getPrice(e,s).then(()=>{this.getRatings(e,s),this.getCategories(e,s),this.getDetails(e,s),this.getDelivery(e,s),this.getBrand(e,s),this.getImage(e,s),i(this.data.asins[e.asin])})))}getBestsellers(e,s){if(!s)return e;this._schema.bestsellers.main={},this._schema.bestsellers.child=[];let i=/bestsellers\/(.*?)\/ref=/g,t=/bestsellers\/(.*?[0-9])\/ref=/g;return s.querySelectorAll('.prodDetTable a[href*="/bestsellers/"],#detailBulletsWrapper_feature_div a[href*="/bestsellers/"]').forEach((a,n)=>{let r=[...a.getAttribute("href").matchAll(i)],h=[...a.getAttribute("href").matchAll(t)];h.length>0?h.forEach((o,l)=>{this._schema.bestsellers.child.push({url:"https://"+this.market_host+a.getAttribute("href"),parent_prefix:o[1].split("/")[0],title:a.innerText.trim(),prefix:o[1].split("/")[1],rank:a.closest("span")?.innerText.replace(",","").replace(".","").match(this.regex.float)[0]})}):r.length>0&&(r.forEach(o=>{let l=o[1];typeof this.bestseller_groups[l]<"u"&&(l=this.bestseller_groups[l]),this._schema.bestsellers.main={url:"https://"+this.market_host+a.getAttribute("href"),prefix:o[1],title:l,rank:a.closest("span")?.innerText.replace(",","").replace(".","").match(this.regex.float)[0]}}),e.bestsellers=this._schema.bestsellers)}),e.bestsellers}getRatings(e,s){let i=s.querySelector("#averageCustomerReviews[data-asin='"+e.asin+"']");this.data.asins[e.asin].rating=this.data.asins[e.asin].rating_count=0,i&&(this.data.asins[e.asin].rating_count=i.querySelector("#acrCustomerReviewText").innerText.match(this.regex.float)[0],this.data.asins[e.asin].rating=i.querySelector("#acrPopover a span").innerText.match(this.regex.float)[0])}getCategories(e,s){let i=s.querySelector("#showing-breadcrumbs_div ul");this.data.asins[e.asin].categories={},this.data.asins[e.asin].main_category={},this.data.asins[e.asin].main_category_id={},this.data.asins[e.asin].group={};let t=D.NodeSearch(s.querySelectorAll("#nav-subnav a"),"Best Sellers")[0]??null;t&&(this.data.asins[e.asin].group=t.getAttribute("href").match(/bestsellers\/(.*?)\//)[1]),i&&i.querySelectorAll("li a").forEach((a,n)=>{let r=a.getAttribute("href").match(/node=([0-9]+$)/);if(r){let h=(r??"")[0].match(this.regex.int);this.data.asins[e.asin].categories[n]={name:a.innerText.trim(),id:h[0]??null},n==0&&(this.data.asins[e.asin].main_category=a.innerText.trim(),this.data.asins[e.asin].main_category_id=h[0]??null)}})}getDetails(e,s){let i=s.querySelectorAll(".prodDetAttrValue,#detailBullets_feature_div ul li > span > span:last-child"),t=null,a=null,n={_length:0,width:0,height:0,unit:null,weight:0,weight_units:null};this.data.asins[e.asin].dimension_match=null,i.forEach(r=>{let h=r?.innerText?.replace("‎","")?.trim(),o=Date.parse(h);o&&(this.data.asins[e.asin].date_first_available_timestamp=o,this.data.asins[e.asin].date_first_available=new Date(o).toLocaleDateString());let l=r?.innerText?.replace("‎","").replace(/\,/g,".")?.trim(),f=null;l&&(f=a),a&&(f+"; "+l).match(this.regex.dimension)?t=(f+"; "+l).match(this.regex.dimension):a&&(l+"; "+f).match(this.regex.dimension)?t=(l+"; "+f).match(this.regex.dimension):l?.match(this.regex.dimension)?t=l?.match(this.regex.dimension):l.split("x").length>2&&console.log(l.split("x")),t&&(n._length=parseFloat(t[1]),n.width=parseFloat(t[2]),n.height=parseFloat(t[3]),n.unit=t[4],t[5]&&t[6]&&(n.weight=t[5]&&parseFloat(t[5]),n.weight_units=t[6]),this.data.asins[e.asin].dimension_match=t),a=l}),this.data.asins[e.asin].dimensions=n}getDelivery(e,s){this.data.asins[e.asin].delivery_time=null,this.data.asins[e.asin].delivery_date=null;let i=s.querySelector("[data-csa-c-delivery-time]")?.getAttribute("data-csa-c-delivery-time");if(!i)return;i.indexOf(" - ")!==-1&&(i=i.split(" - ")[1]),i.indexOf(", ")!==-1&&(i=i.split(", ")[1]),i.indexOf("202")==-1&&(i+=" "+new Date().getFullYear());let t=Date.parse(i);if(t>0){let a=new Date(t);this.data.asins[e.asin].delivery_time=t,this.data.asins[e.asin].delivery_date=a.toLocaleDateString()}}getBrand(e,s){this.data.asins[e.asin].brand=s.querySelector(".po-brand td:last-child span")?.innerText}getImage(e,s){this.data.asins[e.asin].thumbnail=s.querySelector(".imageThumbnail img")?.getAttribute("src"),this.data.asins[e.asin].image=s.querySelector("#imgTagWrapperId [data-old-hires]")?.getAttribute("data-old-hires"),typeof this.data.asins[e.asin].thumbnail>"u"&&(this.data.asins[e.asin].thumbnail=this.data.asins[e.asin].image?.replace("_SL1000_","_US40_"))}getPrice(e,s){let i=0;return fetch(window.location.origin+"/gp/product/ajax/?asin="+e.asin+"&experienceId=aodAjaxMain").then(t=>t.text()).then(t=>{let n=new DOMParser().parseFromString(t,"text/html"),r=n.querySelector(".aod-sticky-pinned-offer")??void 0;typeof r>"u"&&(r=n.querySelectorAll("#aod-offer-soldBy")[0]),typeof(r?.querySelectorAll(".a-offscreen")[0]??void 0)>"u"&&(r=n.querySelectorAll("#aod-offer-soldBy")[0]?.closest("#aod-offer"));let h=r?.querySelectorAll(".a-offscreen")[0].innerText;if(typeof h>"u")return 0;let o=h.match(/[.,]/g),l=0;if(o.length>=2){let u=new RegExp("\\"+o[0],"g");l=h.replace(u,"").replace(o[o.length-1],".")}else o.length===1&&(l=h.replace(o[o.length-1],"."));let f=l.match(this.regex.float)[0]??0,d=r.querySelector("#aod-offer-soldBy *[aria-label]")??null;this.data.asins[e.asin].offers={};let w=r.querySelector("[data-csa-c-delivery-price]")?.getAttribute("data-csa-c-delivery-price")?.match(this.regex.float)??0,T=typeof w[0]<"u"?w[0]:0,S=null;typeof d.getAttribute("href")<"u"&&d.getAttribute("href")?.indexOf("seller=")!=-1&&(S="https://"+this.market_host+d.getAttribute("href"));let A=r.querySelector("#aod-offer-shipsFrom").innerHTML.trim(),_=d.getAttribute("href")?.match(/seller=(.*?)&/);if(_==null&&(_=d.getAttribute("href")?.match(/seller=(.*?)/)),this.data.asins[e.asin].offers[1]={seller_id:_!=null?_[1].trim():_,seller_name:d.innerText.trim(),seller_link:S,price:f,shipping_price:T??0,type:r.querySelector("#aod-offer-heading *").innerHTML.trim().split(" ")[0],vendor:A.indexOf("amazon.")!=-1||A.indexOf("Amazon")!=-1?"FBA":"FBM"},this.data.asins[e.asin].seller_name=this.data.asins[e.asin].offers[1].seller_name,this.data.asins[e.asin].seller_id=this.data.asins[e.asin].offers[1].seller_id,this.data.asins[e.asin].shipping_price=this.data.asins[e.asin].offers[1].shipping_price??0,this.data.asins[e.asin].vendor=this.data.asins[e.asin].offers[1].vendor??0,n.querySelectorAll("#aod-offer-soldBy").forEach((u,F)=>{u.querySelectorAll("[aria-label]").forEach(c=>{if(typeof c?.closest("#aod-offer")<"u"&&c?.closest("#aod-offer")!=null){let y=c?.closest("#aod-offer").querySelector(".a-offscreen").innerText,g=y.match(/[.,]/g),b=0;if(g.length>=2){let x=new RegExp("\\"+g[0],"g");b=y.replace(x,"").replace(g[g.length-1],".")}else g.length===1&&(b=y.replace(g.pop(),"."));let k=b.match(this.regex.float)[0];if(typeof k<"u"&&r.querySelector("[data-csa-c-delivery-price]")){let x=r.querySelector("[data-csa-c-delivery-price]").getAttribute("data-csa-c-delivery-price")?0:r.querySelector("[data-csa-c-delivery-price]").getAttribute("data-csa-c-delivery-price").match(this.regex.float),m=c.getAttribute("href")?.match(/seller=(.*?)&/);m==null&&(m=c.getAttribute("href")?.match(/seller=(.*?)/));let q=null;typeof c.getAttribute("href")<"u"&&c.getAttribute("href")?.indexOf("seller=")!=-1&&(q="https://"+this.market_host+c.getAttribute("href"));let v=c?.closest("#aod-offer").querySelector("#aod-offer-shipsFrom").innerHTML.trim();this.data.asins[e.asin].offers[F]={seller_id:m!=null?m[1].trim():m,seller_name:c.innerText.trim(),seller_link:q,price:k,shipping_price:x?.innerText?.match(this.regex.float)[0]??0,type:c?.closest("#aod-offer")?.querySelector("#aod-offer-heading h5")?.innerHTML?.trim().split(" ")[0],vendor:v.indexOf("amazon.")!=-1||v.indexOf("Amazon")!=-1?"FBA":"FBM"}}}})}),this.data.asins[e.asin].offers){let u=s.querySelector("#olpLinkWidget_feature_div a[href*='offer-listing'] .olp-text-box")?.innerHTML.trim().match(/[0-9]+/)[0]??null;u>0?this.data.asins[e.asin].offer_count=u:this.data.asins[e.asin].offer_count=Object.keys(this.data.asins[e.asin].offers).length}return i=f,this.data.asins[e.asin].price=i,i})}getBestsellerGroups(){fetch(window.location.origin+"/gp/bestsellers/").then(e=>e.text()).then(e=>{let t=new DOMParser().parseFromString(e,"text/html").querySelectorAll("[role='group'] [role='treeitem'] a")??void 0,a=/bestsellers\/(.*?)\/ref=/g;t.forEach(n=>{let r=[...n.getAttribute("href").matchAll(a)][0]??[];typeof r[1]<"u"&&(this.bestseller_groups[r[1]]=n.innerText.trim())}),this.bestseller_groups&&sessionStorage.setItem("bestseller_groups",JSON.stringify(this.bestseller_groups))})}}const B=new P;B.scan().then(()=>{});export{B as CrawlersProductDetails,P as _CrawlersProductDetails};
//# sourceMappingURL=product_details.js.js.map
